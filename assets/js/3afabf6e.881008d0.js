"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1863],{3905:function(e,t,a){a.d(t,{Zo:function(){return h},kt:function(){return u}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),s=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},h=function(e){var t=s(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,h=c(e,["components","mdxType","originalType","parentName"]),d=s(a),u=r,m=d["".concat(l,".").concat(u)]||d[u]||p[u]||i;return a?n.createElement(m,o(o({ref:t},h),{},{components:a})):n.createElement(m,o({ref:t},h))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var s=2;s<i;s++)o[s]=a[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8933:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return c},contentTitle:function(){return l},metadata:function(){return s},toc:function(){return h},default:function(){return d}});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),o=["components"],c={id:"Cachebench_FB_HW_eval",title:"Evaluating SSD hardware for Facebook workloads"},l=void 0,s={unversionedId:"Cache_Library_User_Guides/Cachebench_FB_HW_eval",id:"Cache_Library_User_Guides/Cachebench_FB_HW_eval",isDocsHomePage:!1,title:"Evaluating SSD hardware for Facebook workloads",description:"CacheBench is a cache benchmark tool used to stress the storage and",source:"@site/docs/Cache_Library_User_Guides/Cachebench_FB_HW_eval.md",sourceDirName:"Cache_Library_User_Guides",slug:"/Cache_Library_User_Guides/Cachebench_FB_HW_eval",permalink:"/docs/Cache_Library_User_Guides/Cachebench_FB_HW_eval",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/Cache_Library_User_Guides/Cachebench_FB_HW_eval.md",version:"current",frontMatter:{id:"Cachebench_FB_HW_eval",title:"Evaluating SSD hardware for Facebook workloads"},sidebar:"cachebenchSideBar",previous:{title:"Contributing to Cachebench",permalink:"/docs/Cache_Library_User_Guides/Developing_for_Cachebench"}},h=[{value:"System requirements",id:"system-requirements",children:[]},{value:"Set up the SSD devices using mdraid",id:"set-up-the-ssd-devices-using-mdraid",children:[]},{value:"Installing cachebench",id:"installing-cachebench",children:[]},{value:"Running the benchmark for SSD perf testing",id:"running-the-benchmark-for-ssd-perf-testing",children:[]},{value:"Tuning the workload and cache parameters",id:"tuning-the-workload-and-cache-parameters",children:[]},{value:"Getting the Results",id:"getting-the-results",children:[]},{value:"Plotting latency stats",id:"plotting-latency-stats",children:[]}],p={toc:h};function d(e){var t=e.components,a=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"CacheBench")," is a cache benchmark tool used to stress the storage and\nmemory subsystem in a comparable way that they are stressed\nin production workloads. This doc describes how Facebook leverages CacheBench\nto validate SSD performance."),(0,i.kt)("h2",{id:"system-requirements"},"System requirements"),(0,i.kt)("p",null,"To run CacheBench, first ensure that the machine has\nsufficient free memory (50+GB) and SSD capacity (1TB)."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Memory: 64GB or more"),(0,i.kt)("li",{parentName:"ul"},"SSD Capacity: 100GB or more available capacity"),(0,i.kt)("li",{parentName:"ul"},"Internet connection capable of accessing github.com and installing packages")),(0,i.kt)("h2",{id:"set-up-the-ssd-devices-using-mdraid"},"Set up the SSD devices using mdraid"),(0,i.kt)("p",null,"To gather SSD performance metrics, the SSD must be setup first. An example\nbelow sets up a raid device to handle two ssds being used by CacheBench."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"mdadm --create /dev/md0 --force --raid-devices=2 --level=0 --chunk=256 /dev/nvme1n1 /dev/nvme2n1\n")),(0,i.kt)("h2",{id:"installing-cachebench"},"Installing cachebench"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"If you have not already, clone the cachelib repository from github.com:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"git clone git@github.com:facebook/CacheLib.git\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Build cachelib and ",(0,i.kt)("inlineCode",{parentName:"p"},"cachebench"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"cd CacheLib\n./contrib/build.sh -d -j -v\n")),(0,i.kt)("p",{parentName:"li"}," Note: it will take several minutes to install with all dependencies")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Copy the cachebench executable and the configs to an appropriate location\nfrom which you want to run cachebench:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"}," cp ./opt/cachelib/bin/cachebench <your path>\n cp -r cachebench/test_configs <your path>\n cd <your path>\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"If fio is not installed, build it with:\n``  ````sh\ngit clone ",(0,i.kt)("a",{parentName:"p",href:"mailto:git@github.com"},"git@github.com"),":axboe/fio.git\n./configure\nmake\nmake install"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"")))),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"../installation/installation"},"build and installation")," for further details."),(0,i.kt)("h2",{id:"running-the-benchmark-for-ssd-perf-testing"},"Running the benchmark for SSD perf testing"),(0,i.kt)("p",null,"Cachebench has three configs packaged for SSD validation. These are under ",(0,i.kt)("inlineCode",{parentName:"p"},"test_configs/ssd_perf/<service-domain>"),'. Currently, we have "graph_cache_leader", "kvcache_reg", and "kvcache_wc" which represent three distinct cache workloads from Facebook. Below, we show how the benchmarks can be run for two of these workloads. It is important to trim the ssds between the runs to ensure any interference is avoided.'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Change to the path where you previously copied cachebench to.",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"cd <your path>\n"))),(0,i.kt)("li",{parentName:"ol"},"If ",(0,i.kt)("inlineCode",{parentName:"li"},"/dev/md0")," is not being used, edit workload files appropiately.\nChange all instances of ",(0,i.kt)("inlineCode",{parentName:"li"},"/dev/md0")," to raw path of data SSD(s):",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"vi ./test_configs/ssd_perf/graph_cache_leader/config.json\nvi ./test_configs/ssd_perf/kvcache_l2_wc/config.json\n"))," See ",(0,i.kt)("a",{parentName:"li",href:"Configuring_cachebench_parameters#storage-filedevicedirectory-path-info"},"configuring storage path"),"  for more details on how to configure the storage path."),(0,i.kt)("li",{parentName:"ol"},"Before each benchmark run, fully trim the drive with fio:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"fio --name=trim --filename=/dev/md0 --rw=trim --bs=3G\n"))),(0,i.kt)("li",{parentName:"ol"},"Execute social graph leader cache workload:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"./cachebench -json_test_config test_configs/ssd_perf/graph_cache_leader/config.json --progress_stats_file=/tmp/graph_cache_leader.log\n"))),(0,i.kt)("li",{parentName:"ol"},"Fully trim the drive with fio again:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"fio --name=trim --filename=/dev/md0 --rw=trim --bs=3G\n"))),(0,i.kt)("li",{parentName:"ol"},"Execute the ",(0,i.kt)("inlineCode",{parentName:"li"},"kvcache")," workload:",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"./cachebench -json_test_config test_configs/ssd_perf/kvcache_l2_wc/config.json \u2014progress_stats_file=/tmp/mc-l2-wc.log\n")))),(0,i.kt)("h2",{id:"tuning-the-workload-and-cache-parameters"},"Tuning the workload and cache parameters"),(0,i.kt)("p",null,"For a full list of options that can be configured, see ",(0,i.kt)("a",{parentName:"p",href:"Configuring_cachebench_parameters"},"configuring cachebench")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Duration of Replay")," - To run cachebench operation for longer,\nincrease the ",(0,i.kt)("inlineCode",{parentName:"li"},"numOps")," appropriately in the config file."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Device Info")," - Device info is configured in the config file\nusing the ",(0,i.kt)("inlineCode",{parentName:"li"},"nvmCachePaths")," option.  If you would rather use a\nfilesystem based cache, pass the appropriate path through\n",(0,i.kt)("inlineCode",{parentName:"li"},"nvmCachePaths"),".  The benchmark will create a single file\nunder that path corresponding to the configured ",(0,i.kt)("inlineCode",{parentName:"li"},"nvmCacheSizeMB")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Watching Progress")," -  While the benchmark runs, you can monitor the\nprogress so far. The interval for progress update can be configured\nusing the ",(0,i.kt)("inlineCode",{parentName:"li"},"--progress")," and specifying a duration in seconds.\nIf ",(0,i.kt)("inlineCode",{parentName:"li"},"--progress-stats-file")," is also specified, on every progress\ninterval, ",(0,i.kt)("inlineCode",{parentName:"li"},"cachebench")," would log the internal stats to the specified file.")),(0,i.kt)("h2",{id:"getting-the-results"},"Getting the Results"),(0,i.kt)("p",null," View results summary through the log file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"```sh\ntail -n 50 /tmp/graph_cache_leader.log\ntail -n 50 /tmp/mc-l2-wc.log\n```\n")),(0,i.kt)("h2",{id:"plotting-latency-stats"},"Plotting latency stats"),(0,i.kt)("p",null,"The stats output can be parsed to plot SSD latency information over time. To\ndo this, first ensure ",(0,i.kt)("inlineCode",{parentName:"p"},"gnuplot")," is installed. For example, on CentOs:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"yum install gnuplot\n")),(0,i.kt)("p",null,"Then run this command to get the latency stats:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"./vizualize/extract_latency.sh /tmp/graph_cache_leader.log\n./vizualize/extract_latency.sh /tmp/mc-l2-wc.log\n")),(0,i.kt)("p",null,"This should produce a tsv file for read latency, a tsv file for write latency, and the corresponding ",(0,i.kt)("inlineCode",{parentName:"p"},"png")," files that have the graphs plotted."))}d.isMDXComponent=!0}}]);